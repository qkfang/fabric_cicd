# Azure DevOps Pipeline — Microsoft Fabric CI/CD
# Deploys Fabric workspace items: DEV → QA (with approval) → PROD (with approval)
#
# Prerequisites:
#   1. Create Azure DevOps environments "DEV", "QA", "PROD" with approval gates on QA and PROD.
#   2. Create a variable group "fabric-cicd" with:
#        FABRIC_TENANT_ID, FABRIC_CLIENT_ID, FABRIC_CLIENT_SECRET
#        DEV_WORKSPACE_ID, QA_WORKSPACE_ID, PROD_WORKSPACE_ID
#      Mark secrets as secret variables.
#   3. Optionally use per-environment service principals:
#        DEV_TENANT_ID, DEV_CLIENT_ID, DEV_CLIENT_SECRET, etc.
#   4. Each deploy stage runs a pre-flight check (deploy/preflight_check.py) that
#      validates SP credentials and workspace access before deploying.  If it fails,
#      fix permissions as described in the pre-flight output and re-run the pipeline.

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - workspace/**
      - config/**
      - deploy/**

pool:
  name: azpool

variables:
  - group: fabric-cicd
  - name: pythonVersion
    value: '3.12'
  - name: REPO_DIR
    value: './workspace'
  - name: PARAMETER_FILE
    value: './config/parameter.yml'

stages:
  # ──────────────────────────────────────────────────
  # Validate
  # ──────────────────────────────────────────────────
  - stage: Validate
    displayName: Validate & Lint
    jobs:
      - job: ValidateAndLint
        displayName: Validate repo & lint
        steps:
          - checkout: self

          - script: |
              sudo apt-get update
              sudo apt-get install -y software-properties-common
              sudo add-apt-repository -y ppa:deadsnakes/ppa
              sudo apt-get update
              sudo apt-get install -y python$(pythonVersion) python$(pythonVersion)-venv python$(pythonVersion)-dev
              python$(pythonVersion) --version
              python$(pythonVersion) -m venv $(Agent.TempDirectory)/venv
            displayName: Set up Python $(pythonVersion)

          - script: |
              source $(Agent.TempDirectory)/venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
            displayName: Install dependencies

          - script: |
              source $(Agent.TempDirectory)/venv/bin/activate
              ruff check .
            displayName: Lint with Ruff

          - script: |
              source $(Agent.TempDirectory)/venv/bin/activate
              python deploy/validate_repo.py
            displayName: Validate repository structure

  # ──────────────────────────────────────────────────
  # Deploy to DEV
  # ──────────────────────────────────────────────────
  - stage: DeployDEV
    displayName: Deploy to DEV
    dependsOn: Validate
    jobs:
      - deployment: DeployDEV
        displayName: Deploy to DEV workspace
        environment: DEV
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - script: |
                    sudo apt-get update
                    sudo apt-get install -y software-properties-common
                    sudo add-apt-repository -y ppa:deadsnakes/ppa
                    sudo apt-get update
                    sudo apt-get install -y python$(pythonVersion) python$(pythonVersion)-venv python$(pythonVersion)-dev
                    python$(pythonVersion) --version
                    python$(pythonVersion) -m venv $(Agent.TempDirectory)/venv
                  displayName: Set up Python $(pythonVersion)

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                  displayName: Install dependencies

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    python deploy/preflight_check.py
                  displayName: Pre-flight credential & workspace check
                  env:
                    TARGET_ENVIRONMENT: DEV
                    TARGET_WORKSPACE_ID: $(DEV_WORKSPACE_ID)
                    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
                    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
                    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    python deploy/deploy_workspace.py
                  displayName: Deploy to DEV
                  env:
                    TARGET_ENVIRONMENT: DEV
                    TARGET_WORKSPACE_ID: $(DEV_WORKSPACE_ID)
                    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
                    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
                    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

                - script: |
                    TOKEN=$(az account get-access-token \
                      --resource "https://api.fabric.microsoft.com" \
                      --query accessToken -o tsv 2>/dev/null || true)
                    if [ -n "$TOKEN" ]; then
                      echo "=== Fabric workspace items after DEV deployment ==="
                      curl -sSf \
                        -H "Authorization: Bearer $TOKEN" \
                        "https://api.fabric.microsoft.com/v1/workspaces/$(DEV_WORKSPACE_ID)/items" \
                      | python$(pythonVersion) -c "
                    import json, sys
                    data = json.load(sys.stdin)
                    items = data.get('value', [])
                    print(f'Total items: {len(items)}')
                    for it in items:
                        print(f\"  {it.get('type','?'):20s}  {it.get('displayName','?')}\")
                    " || echo "Could not list items."
                    else
                      echo "Skipping workspace item listing — az CLI not authenticated."
                    fi
                  displayName: Verify deployed workspace items (DEV)
                  condition: succeeded()

                - script: |
                    if [ -f fabric_cicd.error.log ]; then
                      echo "=== fabric_cicd.error.log ==="
                      cat fabric_cicd.error.log
                    else
                      echo "No fabric_cicd.error.log file found."
                    fi
                  displayName: Print fabric_cicd error log
                  condition: always()

                - publish: fabric_cicd.error.log
                  artifact: fabric-cicd-error-log-dev
                  displayName: Upload error log artifact
                  condition: always()

  # ──────────────────────────────────────────────────
  # Deploy to QA (requires approval on the QA environment)
  # ──────────────────────────────────────────────────
  - stage: DeployQA
    displayName: Deploy to QA
    dependsOn: DeployDEV
    jobs:
      - deployment: DeployQA
        displayName: Deploy to QA workspace
        environment: QA
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - script: |
                    sudo apt-get update
                    sudo apt-get install -y software-properties-common
                    sudo add-apt-repository -y ppa:deadsnakes/ppa
                    sudo apt-get update
                    sudo apt-get install -y python$(pythonVersion) python$(pythonVersion)-venv python$(pythonVersion)-dev
                    python$(pythonVersion) --version
                    python$(pythonVersion) -m venv $(Agent.TempDirectory)/venv
                  displayName: Set up Python $(pythonVersion)

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                  displayName: Install dependencies

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    python deploy/preflight_check.py
                  displayName: Pre-flight credential & workspace check
                  env:
                    TARGET_ENVIRONMENT: QA
                    TARGET_WORKSPACE_ID: $(QA_WORKSPACE_ID)
                    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
                    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
                    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    python deploy/deploy_workspace.py
                  displayName: Deploy to QA
                  env:
                    TARGET_ENVIRONMENT: QA
                    TARGET_WORKSPACE_ID: $(QA_WORKSPACE_ID)
                    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
                    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
                    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

                - script: |
                    TOKEN=$(az account get-access-token \
                      --resource "https://api.fabric.microsoft.com" \
                      --query accessToken -o tsv 2>/dev/null || true)
                    if [ -n "$TOKEN" ]; then
                      echo "=== Fabric workspace items after QA deployment ==="
                      curl -sSf \
                        -H "Authorization: Bearer $TOKEN" \
                        "https://api.fabric.microsoft.com/v1/workspaces/$(QA_WORKSPACE_ID)/items" \
                      | python$(pythonVersion) -c "
                    import json, sys
                    data = json.load(sys.stdin)
                    items = data.get('value', [])
                    print(f'Total items: {len(items)}')
                    for it in items:
                        print(f\"  {it.get('type','?'):20s}  {it.get('displayName','?')}\")
                    " || echo "Could not list items."
                    else
                      echo "Skipping workspace item listing — az CLI not authenticated."
                    fi
                  displayName: Verify deployed workspace items (QA)
                  condition: succeeded()

                - script: |
                    if [ -f fabric_cicd.error.log ]; then
                      echo "=== fabric_cicd.error.log ==="
                      cat fabric_cicd.error.log
                    else
                      echo "No fabric_cicd.error.log file found."
                    fi
                  displayName: Print fabric_cicd error log
                  condition: always()

                - publish: fabric_cicd.error.log
                  artifact: fabric-cicd-error-log-qa
                  displayName: Upload error log artifact
                  condition: always()

  # ──────────────────────────────────────────────────
  # Deploy to PROD (requires approval on the PROD environment)
  # ──────────────────────────────────────────────────
  - stage: DeployPROD
    displayName: Deploy to PROD
    dependsOn: DeployQA
    jobs:
      - deployment: DeployPROD
        displayName: Deploy to PROD workspace
        environment: PROD
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - script: |
                    sudo apt-get update
                    sudo apt-get install -y software-properties-common
                    sudo add-apt-repository -y ppa:deadsnakes/ppa
                    sudo apt-get update
                    sudo apt-get install -y python$(pythonVersion) python$(pythonVersion)-venv python$(pythonVersion)-dev
                    python$(pythonVersion) --version
                    python$(pythonVersion) -m venv $(Agent.TempDirectory)/venv
                  displayName: Set up Python $(pythonVersion)

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                  displayName: Install dependencies

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    python deploy/preflight_check.py
                  displayName: Pre-flight credential & workspace check
                  env:
                    TARGET_ENVIRONMENT: PROD
                    TARGET_WORKSPACE_ID: $(PROD_WORKSPACE_ID)
                    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
                    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
                    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

                - script: |
                    source $(Agent.TempDirectory)/venv/bin/activate
                    python deploy/deploy_workspace.py
                  displayName: Deploy to PROD
                  env:
                    TARGET_ENVIRONMENT: PROD
                    TARGET_WORKSPACE_ID: $(PROD_WORKSPACE_ID)
                    FABRIC_TENANT_ID: $(FABRIC_TENANT_ID)
                    FABRIC_CLIENT_ID: $(FABRIC_CLIENT_ID)
                    FABRIC_CLIENT_SECRET: $(FABRIC_CLIENT_SECRET)

                - script: |
                    TOKEN=$(az account get-access-token \
                      --resource "https://api.fabric.microsoft.com" \
                      --query accessToken -o tsv 2>/dev/null || true)
                    if [ -n "$TOKEN" ]; then
                      echo "=== Fabric workspace items after PROD deployment ==="
                      curl -sSf \
                        -H "Authorization: Bearer $TOKEN" \
                        "https://api.fabric.microsoft.com/v1/workspaces/$(PROD_WORKSPACE_ID)/items" \
                      | python$(pythonVersion) -c "
                    import json, sys
                    data = json.load(sys.stdin)
                    items = data.get('value', [])
                    print(f'Total items: {len(items)}')
                    for it in items:
                        print(f\"  {it.get('type','?'):20s}  {it.get('displayName','?')}\")
                    " || echo "Could not list items."
                    else
                      echo "Skipping workspace item listing — az CLI not authenticated."
                    fi
                  displayName: Verify deployed workspace items (PROD)
                  condition: succeeded()

                - script: |
                    if [ -f fabric_cicd.error.log ]; then
                      echo "=== fabric_cicd.error.log ==="
                      cat fabric_cicd.error.log
                    else
                      echo "No fabric_cicd.error.log file found."
                    fi
                  displayName: Print fabric_cicd error log
                  condition: always()

                - publish: fabric_cicd.error.log
                  artifact: fabric-cicd-error-log-prod
                  displayName: Upload error log artifact
                  condition: always()
